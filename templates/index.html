<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AkBot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      height: 100vh; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      position: relative;
    }

    /* Animated background particles */
    .bg-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }

    #chat-container { 
      width: 100%; 
      max-width: 800px; 
      height: 85vh; 
      display: flex; 
      flex-direction: column; 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px; 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.05); 
      overflow: hidden;
      margin: 0 20px;
      position: relative;
      z-index: 1;
    }

    /* Modern header with avatar */
    #chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .bot-avatar {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .header-content {
      flex: 1;
    }

    .bot-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .bot-status {
      font-size: 12px;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
      animation: blink 2s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }

    /* Messages area with improved styling */
    #messages { 
      flex: 1; 
      overflow-y: auto; 
      padding: 24px; 
      background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
      display: flex; 
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }
    
    /* Modern chat bubbles */
    .msg { 
      max-width: 75%; 
      padding: 16px 20px; 
      border-radius: 20px; 
      animation: messageSlide 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
      word-wrap: break-word; 
      line-height: 1.5;
      font-size: 15px;
      position: relative;
      backdrop-filter: blur(10px);
    }

    @keyframes messageSlide {
      0% { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95);
      }
      100% { 
        opacity: 1; 
        transform: translateY(0) scale(1);
      }
    }

    .user { 
      align-self: flex-end; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      border-bottom-right-radius: 8px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .bot { 
      align-self: flex-start; 
      background: rgba(255, 255, 255, 0.9);
      color: #334155; 
      border-bottom-left-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* Text formatting with better colors */
    .msg strong, .msg b {
      font-weight: 600;
      color: inherit;
    }
    
    .msg em, .msg i {
      font-style: italic;
      color: inherit;
    }
    
    .msg code {
      background: rgba(0, 0, 0, 0.1);
      color: #e11d48;
      padding: 4px 8px;
      border-radius: 6px;
      font-family: 'JetBrains Mono', 'Monaco', monospace;
      font-size: 0.9em;
      font-weight: 500;
    }
    
    .user code {
      background: rgba(255, 255, 255, 0.2);
      color: #fef3c7;
    }

    .msg pre {
      background: rgba(15, 23, 42, 0.95);
      color: #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      overflow-x: auto;
      font-family: 'JetBrains Mono', 'Monaco', monospace;
      font-size: 0.85em;
      line-height: 1.5;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Mathematical expressions with glassmorphism */
    .msg .math-inline {
      background: rgba(139, 92, 246, 0.1);
      color: #7c3aed;
      padding: 4px 10px;
      border-radius: 8px;
      font-family: 'Times New Roman', serif;
      font-size: 1.1em;
      font-weight: 500;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .msg .math-block {
      background: rgba(139, 92, 246, 0.05);
      border: 2px solid rgba(139, 92, 246, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      text-align: center;
      font-family: 'Times New Roman', serif;
      font-size: 1.3em;
      color: #7c3aed;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    /* Modern input area */
    #input-container {
      padding: 20px 24px;
      background: rgba(248, 250, 252, 0.8);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    #input-box { 
      display: flex; 
      align-items: center;
      gap: 12px;
      background: white;
      border-radius: 16px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.1);
      transition: all 0.3s ease;
    }

    #input-box:focus-within {
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
      border-color: #667eea;
    }

    #query { 
      flex: 1; 
      padding: 12px 16px; 
      border: none;
      background: transparent;
      font-size: 15px;
      outline: none;
      color: #334155;
      font-family: inherit;
    }

    #query::placeholder {
      color: #94a3b8;
    }

    #send-btn { 
      padding: 12px; 
      border: none; 
      border-radius: 12px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      cursor: pointer; 
      font-size: 16px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      height: 44px;
    }

    #send-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    #send-btn:active {
      transform: translateY(0);
    }

    #send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Improved typing animation */
    .thinking { 
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #64748b;
      font-style: italic;
    }

    .thinking-dots {
      display: flex;
      gap: 2px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #94a3b8;
      animation: thinkingBounce 1.4s infinite both;
    }

    .thinking-dots span:nth-child(1) { animation-delay: 0s; }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinkingBounce {
      0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% { 
        transform: scale(1.2);
        opacity: 1;
      }
    }

    /* Scrollbar styling */
    #messages::-webkit-scrollbar {
      width: 8px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 4px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.5);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 0;
        align-items: stretch;
      }

      #chat-container {
        height: 100vh;
        max-width: none;
        margin: 0;
        border-radius: 0;
        border: none;
      }

      #chat-header {
        padding: 16px 20px;
        border-radius: 0;
      }

      .bot-avatar {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .bot-name {
        font-size: 18px;
      }

      #messages {
        padding: 16px;
        gap: 12px;
      }

      .msg {
        max-width: 85%;
        padding: 12px 16px;
        font-size: 14px;
      }

      #input-container {
        padding: 16px 20px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
      }

      #input-box {
        padding: 6px;
      }

      #query {
        padding: 10px 12px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      #send-btn {
        width: 40px;
        height: 40px;
        font-size: 14px;
      }
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      #chat-container {
        background: rgba(15, 23, 42, 0.95);
      }

      #messages {
        background: linear-gradient(to bottom, #0f172a, #1e293b);
      }

      .bot {
        background: rgba(30, 41, 59, 0.8);
        color: #e2e8f0;
        border-color: rgba(71, 85, 105, 0.3);
      }

      #input-container {
        background: rgba(15, 23, 42, 0.8);
        border-top-color: rgba(71, 85, 105, 0.3);
      }

      #input-box {
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(71, 85, 105, 0.3);
      }

      #query {
        color: #e2e8f0;
      }

      #query::placeholder {
        color: #64748b;
      }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="bg-particles" id="particles"></div>
  
  <div id="chat-container">
    <div id="chat-header">
      <div class="bot-avatar">
        <i class="fa-solid fa-robot"></i>
      </div>
      <div class="header-content">
        <div class="bot-name">AkBot</div>
        <div class="bot-status">
          <div class="status-dot"></div>
          Online & Ready to Help
        </div>
      </div>
    </div>
    
    <div id="messages"></div>
    
    <div id="input-container">
      <div id="input-box">
        <input 
          id="query" 
          placeholder="Ask me anything ..." 
          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendMessage()}"
          autocomplete="off"
        />
        <button id="send-btn" onclick="sendMessage()">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Create animated background particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      
      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        const size = Math.random() * 4 + 2;
        const left = Math.random() * 100;
        const duration = Math.random() * 10 + 10;
        const delay = Math.random() * 15;
        
        particle.style.cssText = `
          width: ${size}px;
          height: ${size}px;
          left: ${left}%;
          animation-duration: ${duration}s;
          animation-delay: ${delay}s;
        `;
        
        particlesContainer.appendChild(particle);
      }
    }

    // Initialize particles
    createParticles();

    // Viewport handling for mobile
    function handleViewportChange() {
      if (window.visualViewport && window.innerWidth <= 768) {
        const messages = document.getElementById('messages');
        const container = document.getElementById('chat-container');
        const header = document.getElementById('chat-header');
        const inputContainer = document.getElementById('input-container');
        
        const headerHeight = header.offsetHeight;
        const inputHeight = inputContainer.offsetHeight;
        const availableHeight = window.visualViewport.height - headerHeight - inputHeight;
        
        messages.style.height = `${Math.max(200, availableHeight)}px`;
        scrollToBottom();
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', handleViewportChange);
    }

    window.addEventListener('load', handleViewportChange);
    window.addEventListener('resize', handleViewportChange);

    let isProcessing = false;

    // Enhanced text formatting
    function formatText(text) {
      return text
        // Math expressions
        .replace(/\$\$([^$]+)\$\$/g, '<span class="math-block">$1</span>')
        .replace(/\$([^$\s][^$]*[^$\s])\$/g, '<span class="math-inline">$1</span>')
        // Superscript and subscript
        .replace(/([a-zA-Z0-9])\^([0-9]+)/g, '$1<sup>$2</sup>')
        .replace(/([a-zA-Z0-9])_([0-9]+)/g, '$1<sub>$2</sub>')
        // Text formatting
        .replace(/\*\*([^*\n]+)\*\*/g, '<strong>$1</strong>')
        .replace(/(?<!\*)\*([^*\n]+)\*(?!\*)/g, '<em>$1</em>')
        .replace(/__([^_\n]+)__/g, '<u>$1</u>')
        .replace(/==([^=\n]+)==/g, '<mark>$1</mark>')
        .replace(/`([^`\n]+)`/g, '<code>$1</code>')
        // Block quotes
        .replace(/^>\s(.+)$/gm, '<blockquote>$1</blockquote>')
        // Code blocks
        .replace(/```([^`]+)```/g, '<pre>$1</pre>')
        // Line breaks
        .replace(/\n/g, '<br>');
    }

    function linkify(text) {
      const urlPattern = /(\bhttps?:\/\/[^\s<]+|\bwww\.[^\s<]+)/g;
      return text.replace(urlPattern, function(url) {
        let href = url;
        if (!href.startsWith("http")) {
          href = "http://" + href;
        }
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    function scrollToBottom() {
      const msgBox = document.getElementById("messages");
      requestAnimationFrame(() => {
        msgBox.scrollTop = msgBox.scrollHeight;
      });
    }

    async function sendMessage() {
      if (isProcessing) return; 
      
      const queryInput = document.getElementById("query");
      const query = queryInput.value.trim();
      if (!query) return;

      isProcessing = true;
      const sendBtn = document.getElementById("send-btn");
      sendBtn.disabled = true;

      const msgBox = document.getElementById("messages");
      
      // Add user message
      const userMsg = document.createElement("div");
      userMsg.className = "msg user";
      const formattedUserText = formatText(query);
      userMsg.innerHTML = linkify(formattedUserText);
      msgBox.appendChild(userMsg);
      
      queryInput.value = "";
      scrollToBottom();

      // Add thinking animation
      const thinkingEl = document.createElement("div");
      thinkingEl.className = "msg bot thinking";
      thinkingEl.innerHTML = `
        <i class="fa-solid fa-brain" style="color: #667eea;"></i>
        Thinking
        <div class="thinking-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      msgBox.appendChild(thinkingEl);
      scrollToBottom();

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ query })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        
        // Remove thinking animation
        if (msgBox.contains(thinkingEl)) {
          msgBox.removeChild(thinkingEl);
        }

        // Add bot response
        const botMsg = document.createElement("div");
        botMsg.className = "msg bot";
        const formattedText = formatText(data.answer || "I'm sorry, I couldn't process that request. Please try again.");
        botMsg.innerHTML = linkify(formattedText);
        msgBox.appendChild(botMsg);
        
      } catch (error) {
        console.error('Chat error:', error);
        
        // Remove thinking animation
        if (msgBox.contains(thinkingEl)) {
          msgBox.removeChild(thinkingEl);
        }

        // Add error message
        const errorMsg = document.createElement("div");
        errorMsg.className = "msg bot";
        errorMsg.innerHTML = `
          <i class="fa-solid fa-exclamation-triangle" style="color: #ef4444; margin-right: 8px;"></i>
          I'm experiencing technical difficulties. Please check your connection and try again.
        `;
        msgBox.appendChild(errorMsg);
      }

      scrollToBottom();
      isProcessing = false;
      sendBtn.disabled = false;
      
      // Auto-focus input on desktop
      if (window.innerWidth > 768) {
        queryInput.focus();
      }
    }

    // Auto-focus input on desktop load
    window.addEventListener('load', () => {
      if (window.innerWidth > 768) {
        document.getElementById("query").focus();
      }
    });

    // Add welcome message
    window.addEventListener('load', () => {
      const msgBox = document.getElementById("messages");
      const welcomeMsg = document.createElement("div");
      welcomeMsg.className = "msg bot";
      welcomeMsg.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <i class="fa-solid fa-sparkles" style="color: #667eea;"></i>
          <strong>Welcome to AkBot!</strong>
        </div>
        I'm here to help you with informations about Anik. Just type your message below to get started!
      `;
      msgBox.appendChild(welcomeMsg);
      scrollToBottom();
    });
  </script>
</body>
</html>